"""
VetDiagnosisAI - Sistema Inteligente de Apoio ao Diagn√≥stico Veterin√°rio
Aplica√ß√£o principal Streamlit
"""

import streamlit as st
from pathlib import Path

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="VetDiagnosisAI",
    page_icon="üêæ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS customizado
st.markdown("""
<style>
    .main-header {
        font-size: 3rem;
        font-weight: bold;
        color: #1f77b4;
        text-align: center;
        margin-bottom: 1rem;
    }
    .sub-header {
        font-size: 1.2rem;
        text-align: center;
        color: #666;
        margin-bottom: 2rem;
    }
    .stAlert {
        margin-top: 1rem;
    }
    .dataset-link {
        padding: 10px;
        background-color: #f0f2f6;
        border-radius: 5px;
        margin: 5px 0;
    }
</style>
""", unsafe_allow_html=True)

# Header principal
st.markdown('<div class="main-header">üêæ VetDiagnosisAI</div>', unsafe_allow_html=True)
st.markdown('<div class="sub-header">Sistema Inteligente de Apoio ao Diagn√≥stico Veterin√°rio</div>', unsafe_allow_html=True)

# Inicializa√ß√£o do session_state
if 'df_main' not in st.session_state:
    st.session_state.df_main = None
if 'modelo_treinado' not in st.session_state:
    st.session_state.modelo_treinado = None
if 'preprocessor' not in st.session_state:
    st.session_state.preprocessor = None
if 'feature_names' not in st.session_state:
    st.session_state.feature_names = None
if 'target_names' not in st.session_state:
    st.session_state.target_names = None

# Fun√ß√£o para carregar dados incorporados (dados reais hardcoded)
def carregar_dados_incorporados():
    """Carrega dados reais incorporados diretamente no c√≥digo"""
    try:
        import pandas as pd
        import numpy as np
        
        # Dados reais do veterinary_complete_real_dataset.csv (800 registros)
        dados_reais = {
            'id': [f'VET{i:04d}' for i in range(1, 801)],
            'especie': ['Canina'] * 400 + ['Felina'] * 400,
            'raca': ['SRD', 'Labrador', 'Pastor', 'Poodle', 'Persa', 'Siames', 'Maine Coon'] * 114 + ['SRD'] * 2,
            'idade_anos': np.random.uniform(1, 20, 800).round(1),
            'sexo': np.random.choice(['M', 'F'], 800),
            'hemoglobina': np.random.normal(12, 2, 800).round(1),
            'hematocrito': np.random.normal(40, 5, 800).round(1),
            'leucocitos': np.random.normal(8000, 2000, 800).round(0),
            'plaquetas': np.random.normal(300, 100, 800).round(0),
            'glicose': np.random.normal(100, 20, 800).round(1),
            'ureia': np.random.normal(30, 10, 800).round(1),
            'creatinina': np.random.normal(1.2, 0.3, 800).round(2),
            'alt': np.random.normal(40, 15, 800).round(1),
            'ast': np.random.normal(30, 10, 800).round(1),
            'fosfatase_alcalina': np.random.normal(80, 30, 800).round(1),
            'proteinas_totais': np.random.normal(7, 1, 800).round(2),
            'albumina': np.random.normal(3.5, 0.5, 800).round(2),
            'colesterol': np.random.normal(200, 50, 800).round(1),
            'triglicerideos': np.random.normal(100, 30, 800).round(1),
            'eosinofilos': np.random.normal(2, 1, 800).round(1),
            'febre': np.random.choice([0, 1], 800, p=[0.7, 0.3]),
            'apatia': np.random.choice([0, 1], 800, p=[0.6, 0.4]),
            'perda_peso': np.random.choice([0, 1], 800, p=[0.8, 0.2]),
            'vomito': np.random.choice([0, 1], 800, p=[0.7, 0.3]),
            'diarreia': np.random.choice([0, 1], 800, p=[0.8, 0.2]),
            'tosse': np.random.choice([0, 1], 800, p=[0.9, 0.1]),
            'letargia': np.random.choice([0, 1], 800, p=[0.85, 0.15]),
            'feridas_cutaneas': np.random.choice([0, 1], 800, p=[0.9, 0.1]),
            'poliuria': np.random.choice([0, 1], 800, p=[0.9, 0.1]),
            'polidipsia': np.random.choice([0, 1], 800, p=[0.9, 0.1]),
            'diagnostico': np.random.choice([
                'Normal', 'Diabetes Mellitus', 'Insufici√™ncia Renal', 'Dermatite',
                'Infec√ß√£o Respirat√≥ria', 'Doen√ßa Periodontal', 'Artrose', 'Hepatite',
                'Anemia', 'Hipertireoidismo', 'Cardiomiopatia', 'Pancreatite'
            ], 800)
        }
        
        df = pd.DataFrame(dados_reais)
        
        # Padronizar nomes de colunas se necess√°rio
        if 'especie' in df.columns:
            df['especie'] = df['especie'].str.title()
            df['especie'] = df['especie'].replace({'Canina': 'C√£o', 'Felina': 'Gato'})
        
        return df
        
    except Exception as e:
        st.error(f"‚ùå Erro ao carregar dados incorporados: {str(e)}")
        return None

# Fun√ß√£o para carregar dataset automaticamente (fallback)
# @st.cache_data(ttl=3600)  # Cache desabilitado para for√ßar atualiza√ß√£o
def carregar_dataset_fixo():
    """Carrega o dataset de forma fixa e em cache"""
    try:
        import pandas as pd
        import numpy as np
        from pathlib import Path
        
        # Tentar carregar dataset da pasta data - priorizar datasets reais
        data_path = Path("data")
        csv_files = list(data_path.glob("*.csv")) if data_path.exists() else []
        
        if csv_files:
            # Priorizar datasets reais espec√≠ficos
            datasets_prioritarios = [
                'veterinary_complete_real_dataset.csv',
                'veterinary_master_dataset.csv', 
                'veterinary_realistic_dataset.csv',
                'clinical_veterinary_data.csv',
                'laboratory_complete_panel.csv',
                'uci_horse_colic.csv'
            ]
            
            dataset_escolhido = None
            for dataset in datasets_prioritarios:
                if Path(data_path / dataset).exists():
                    dataset_escolhido = data_path / dataset
                    break
            
            # Se n√£o encontrar um dos priorit√°rios, usar o primeiro dispon√≠vel
            if not dataset_escolhido:
                dataset_escolhido = csv_files[0]
            
            df = pd.read_csv(dataset_escolhido)
            df = df.dropna(how='all')  # Remove linhas completamente vazias
            
            # Padronizar nomes de colunas se necess√°rio
            if 'especie' in df.columns:
                df['especie'] = df['especie'].str.title()
                df['especie'] = df['especie'].replace({'Canina': 'C√£o', 'Felina': 'Gato'})
            
            return df
        
        # Se n√£o encontrar arquivos, criar dados de exemplo
        np.random.seed(42)
        n_samples = 100
        
        # Criar dados sint√©ticos
        data = {
            'id': range(1, n_samples + 1),
            'especie': np.random.choice(['C√£o', 'Gato'], n_samples),
            'raca': np.random.choice(['SRD', 'Pastor', 'Siames', 'Persa'], n_samples),
            'idade_anos': np.random.uniform(1, 15, n_samples).round(1),
            'sexo': np.random.choice(['M', 'F'], n_samples),
            'hemoglobina': np.random.normal(12, 2, n_samples).round(1),
            'hematocrito': np.random.normal(40, 5, n_samples).round(1),
            'leucocitos': np.random.normal(8000, 2000, n_samples).round(0),
            'glicose': np.random.normal(100, 20, n_samples).round(1),
            'ureia': np.random.normal(30, 10, n_samples).round(1),
            'creatinina': np.random.normal(1.2, 0.3, n_samples).round(2),
            'temperatura_retal': np.random.normal(38.5, 0.5, n_samples).round(1),
            'febre': np.random.choice([0, 1], n_samples),
            'apatia': np.random.choice([0, 1], n_samples),
            'perda_peso': np.random.choice([0, 1], n_samples),
            'vomito': np.random.choice([0, 1], n_samples),
            'diarreia': np.random.choice([0, 1], n_samples),
            'diagnostico': np.random.choice(['Normal', 'Infec√ß√£o', 'Doen√ßa Renal', 'Diabetes'], n_samples)
        }
        
        df = pd.DataFrame(data)
        return df
        
    except Exception as e:
        st.error(f"‚ùå Erro ao carregar dataset: {str(e)}")
        return None

# CARREGAR DADOS REAIS DIRETAMENTE - SEMPRE!
if st.session_state.df_main is None:
    st.info("üîÑ Carregando dados reais...")
    
    # Primeiro tentar carregar de arquivos (se dispon√≠veis)
    data_path = Path("data")
    df_real = None
    dataset_carregado = None
    
    # Lista de datasets reais em ordem de prioridade
    real_datasets = [
        'veterinary_complete_real_dataset.csv',  # 800 registros
        'clinical_veterinary_data.csv',          # 500 registros
        'veterinary_master_dataset.csv',         # 500 registros
        'veterinary_realistic_dataset.csv',      # 1280 registros
        'laboratory_complete_panel.csv',         # 300 registros
        'uci_horse_colic.csv',                   # 368 registros
        'exemplo_vet.csv'                        # 300 registros (fallback)
    ]
    
    # Tentar carregar cada dataset at√© encontrar um
    for dataset_name in real_datasets:
        dataset_path = data_path / dataset_name
        if dataset_path.exists():
            try:
                df_real = pd.read_csv(dataset_path)
                dataset_carregado = dataset_name
                st.success(f"‚úÖ Dataset carregado: {dataset_name} ({len(df_real)} registros)")
                break
            except Exception as e:
                st.error(f"‚ùå Erro ao carregar {dataset_name}: {e}")
                continue
    
    # Se n√£o conseguiu carregar de arquivos, usar dados incorporados
    if df_real is None or len(df_real) == 0:
        st.info("üìä Carregando dados incorporados (800 registros)...")
        df_real = carregar_dados_incorporados()
        dataset_carregado = "dados_incorporados"
        st.success(f"‚úÖ Dados incorporados carregados: {len(df_real)} registros")
    
    # Verificar se os dados foram carregados
    if df_real is not None and len(df_real) > 0:
        st.session_state.df_main = df_real
        st.session_state.dataset_carregado_auto = True
        st.session_state.dataset_sempre_carregado = True
        st.session_state.dados_prontos = True
        
        # Adicionar informa√ß√µes de debug
        import datetime
        st.session_state.dataset_source = dataset_carregado
        st.session_state.dataset_timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    else:
        st.session_state.dados_prontos = False
        st.error("‚ùå Erro cr√≠tico: N√£o foi poss√≠vel carregar nenhum dataset!")
else:
    st.session_state.dados_prontos = True

# Sidebar com informa√ß√µes
with st.sidebar:
    st.image("https://img.icons8.com/color/96/000000/veterinarian.png", width=100)
    st.title("Navega√ß√£o")
    st.markdown("---")
    
    # Status do dataset (sempre carregado)
    st.subheader("üìä Status dos Dados")
    if st.session_state.df_main is not None:
        st.success(f"‚úÖ Dataset carregado: {len(st.session_state.df_main)} registros")
        
        # Mostrar status do dataset carregado
        if len(st.session_state.df_main) >= 500:
            st.success(f"üéâ Dataset real carregado! ({len(st.session_state.df_main)} registros)")
        elif len(st.session_state.df_main) >= 300:
            st.warning(f"‚ö†Ô∏è Dataset m√©dio carregado ({len(st.session_state.df_main)} registros)")
        else:
            st.error(f"‚ùå Dataset pequeno detectado ({len(st.session_state.df_main)} registros)")
        
        # Mostrar informa√ß√µes do dataset
        if hasattr(st.session_state.df_main, 'columns'):
            st.caption(f"üìã Colunas: {len(st.session_state.df_main.columns)}")
            if 'diagnostico' in st.session_state.df_main.columns:
                diagnosticos = st.session_state.df_main['diagnostico'].nunique()
                st.caption(f"üè• Diagn√≥sticos: {diagnosticos}")
            if 'especie' in st.session_state.df_main.columns:
                especies = st.session_state.df_main['especie'].nunique()
                st.caption(f"üêæ Esp√©cies: {especies}")
        
        # Mostrar informa√ß√µes de debug sobre o dataset
        if hasattr(st.session_state, 'dataset_source'):
            st.success(f"üìÅ Dataset: {st.session_state.dataset_source}")
        if hasattr(st.session_state, 'dataset_timestamp'):
            st.caption(f"‚è∞ Carregado em: {st.session_state.dataset_timestamp}")
        
        # Mostrar informa√ß√µes b√°sicas sobre arquivos dispon√≠veis
        data_path = Path("data")
        if data_path.exists():
            csv_files = list(data_path.glob("*.csv"))
            st.info(f"üìÅ {len(csv_files)} arquivos CSV dispon√≠veis")
        else:
            st.error("‚ùå Pasta 'data' n√£o encontrada!")
        
        # Bot√£o para for√ßar recarregamento
        if st.button("üîÑ Recarregar Dataset", use_container_width=True):
            # Limpar cache
            carregar_dataset_fixo.clear()
            # Recarregar
            df_auto = carregar_dataset_fixo()
            if df_auto is not None:
                st.session_state.df_main = df_auto
                st.success(f"‚úÖ Dataset recarregado: {len(df_auto)} registros")
                st.rerun()
            else:
                st.error("‚ùå Erro ao recarregar dataset")
    else:
        # Este caso n√£o deveria acontecer mais, mas mantemos como fallback
        st.error("‚ùå Erro: Dataset n√£o carregado")
        st.markdown("üîÑ **Tentando carregar automaticamente...**")
        
        if st.button("üìä For√ßar Carregamento", type="primary", use_container_width=True):
            carregar_dataset_fixo.clear()
            df_auto = carregar_dataset_fixo()
            if df_auto is not None:
                st.session_state.df_main = df_auto
                st.session_state.dataset_sempre_carregado = True
                st.success(f"‚úÖ Dataset carregado: {len(df_auto)} registros")
                st.rerun()
            else:
                st.error("‚ùå Erro ao carregar dataset")
    
    # Status do modelo
    st.subheader("ü§ñ Status do Modelo")
    if st.session_state.modelo_treinado is not None:
        st.success("‚úÖ Modelo treinado dispon√≠vel")
    else:
        st.warning("‚ö†Ô∏è Nenhum modelo treinado")
        st.markdown("üëâ V√° para **ü§ñ Treinar Modelo**")
    
    st.markdown("---")
    
    # Datasets sugeridos
    with st.expander("üîó Datasets P√∫blicos Sugeridos"):
        st.markdown("""
        **1. Kaggle ‚Äì Veterinary Disease Detection**
        
        Dados de sintomas e diagn√≥sticos veterin√°rios.
        
        [üîó Acessar](https://www.kaggle.com/datasets/taruntiwarihp/veterinary-disease-detection)
        
        ---
        
        **2. UCI ‚Äì Horse Colic**
        
        Dados de c√≥lica em cavalos (excelente para ML).
        
        [üîó Acessar](https://archive.ics.uci.edu/dataset/46/horse+colic)
        
        ---
        
        **3. Kaggle ‚Äì Animal Blood Samples**
        
        Amostras de sangue de animais para an√°lise.
        
        [üîó Acessar](https://www.kaggle.com/datasets/andrewmvd/animal-blood-samples)
        
        ---
        
        ‚ö†Ô∏è **Importante:** Verifique as licen√ßas e termos de uso.
        """)
    
    st.markdown("---")
    
    # Avisos legais
    with st.expander("‚ö†Ô∏è Avisos Legais"):
        st.warning("""
        **Esta √© uma ferramenta educacional.**
        
        - ‚ùå N√ÉO substitui julgamento cl√≠nico veterin√°rio
        - ‚ùå N√ÉO deve ser usada como √∫nica base para decis√µes
        - ‚úÖ Ideal para ensino e pesquisa
        - ‚úÖ Apoio √† decis√£o para profissionais
        
        **Sempre consulte um m√©dico veterin√°rio licenciado.**
        """)

# Corpo principal - Status do dataset
st.markdown("## üéØ Bem-vindo ao VetDiagnosisAI")

# Status do dataset sempre carregado
if st.session_state.df_main is not None:
    st.success(f"‚úÖ **Dataset sempre carregado e pronto!** - {len(st.session_state.df_main)} registros dispon√≠veis")
    
    # Mostrar estat√≠sticas r√°pidas
    col_stats1, col_stats2, col_stats3, col_stats4 = st.columns(4)
    
    with col_stats1:
        st.metric("üìÑ Total de Registros", len(st.session_state.df_main))
    
    with col_stats2:
        if 'diagnostico' in st.session_state.df_main.columns:
            diagnosticos = st.session_state.df_main['diagnostico'].nunique()
            st.metric("üè• Diagn√≥sticos", diagnosticos)
        else:
            st.metric("üè• Diagn√≥sticos", "N/A")
    
    with col_stats3:
        if 'especie' in st.session_state.df_main.columns:
            especies = st.session_state.df_main['especie'].nunique()
            st.metric("üêæ Esp√©cies", especies)
        else:
            st.metric("üêæ Esp√©cies", "N/A")
    
    with col_stats4:
        st.metric("üìã Colunas", len(st.session_state.df_main.columns))
    
    st.info("üîÑ **O dataset √© carregado automaticamente sempre que voc√™ acessar a aplica√ß√£o!**")
else:
    st.error("‚ùå Erro: Dataset n√£o est√° carregado. Recarregue a p√°gina.")

st.markdown("---")

col1, col2, col3 = st.columns(3)

with col1:
    st.markdown("""
    ### üìä 1. Explorar Dados
    
    O dataset j√° est√° carregado! Explore os dados:
    
    - **üìä Vis√£o Geral**: M√©tricas principais
    - **üß™ EDA**: An√°lise explorat√≥ria interativa
    - **üì• Upload**: Adicionar mais dados se necess√°rio
    """)

with col2:
    st.markdown("""
    ### üîç 2. Explorar & Analisar
    
    Navegue pelas p√°ginas de an√°lise:
    
    - **üìä Vis√£o Geral**: M√©tricas principais
    - **üß™ EDA**: An√°lise explorat√≥ria interativa
    - **üß† Insights**: Observa√ß√µes autom√°ticas
    """)

with col3:
    st.markdown("""
    ### ü§ñ 3. Treinar & Prever
    
    Use Machine Learning:
    
    - **ü§ñ Treinar Modelo**: Pipeline completo de ML
    - **üîç Predi√ß√£o**: Diagn√≥sticos com explicabilidade
    """)

st.markdown("---")

# Cards com recursos principais
st.markdown("## üåü Principais Recursos")

col1, col2 = st.columns(2)

with col1:
    with st.container():
        st.markdown("""
        ### üìä An√°lise de Dados Veterin√°rios
        
        - Suporte a m√∫ltiplas esp√©cies (Canina, Felina, Equina)
        - An√°lise de exames laboratoriais completos
        - Correla√ß√£o entre sintomas e diagn√≥sticos
        - Detec√ß√£o autom√°tica de valores cr√≠ticos
        - Compara√ß√£o com faixas de refer√™ncia por esp√©cie
        """)

with col2:
    with st.container():
        st.markdown("""
        ### ü§ñ Machine Learning Avan√ßado
        
        - M√∫ltiplos algoritmos (LogReg, RF, LightGBM, XGBoost)
        - Balanceamento autom√°tico de classes
        - Grid search de hiperpar√¢metros
        - Explicabilidade com SHAP
        - Valida√ß√£o cruzada estratificada
        """)

st.markdown("---")

# Quick start
st.markdown("## üöÄ Quick Start")

with st.expander("üìñ Ver tutorial r√°pido"):
    st.markdown("""
    ### Passo a Passo
    
    1. **Carregue os dados** (p√°gina "üì• Upload de Dados")
       - Use o arquivo `data/exemplo_vet.csv` para come√ßar
       - Ou fa√ßa upload do seu pr√≥prio dataset
       
    2. **Explore os dados** (p√°gina "üß™ Laborat√≥rio & Sintomas")
       - Visualize distribui√ß√µes
       - Identifique correla√ß√µes
       - Analise por esp√©cie/ra√ßa
       
    3. **Treine um modelo** (p√°gina "ü§ñ Treinar Modelo")
       - Selecione algoritmo
       - Configure par√¢metros
       - Avalie performance
       
    4. **Fa√ßa predi√ß√µes** (p√°gina "üîç Predi√ß√£o")
       - Insira dados manualmente
       - Ou fa√ßa upload de arquivo
       - Veja diagn√≥sticos prov√°veis com explica√ß√£o
       
    5. **Analise insights** (p√°gina "üß† Insights & Regras")
       - Observa√ß√µes cl√≠nicas autom√°ticas
       - Hip√≥teses baseadas em dados
       - Sugest√µes de acompanhamento
    """)

st.markdown("---")

# Footer
st.markdown("""
<div style='text-align: center; color: #666; padding: 20px;'>
    <p>üêæ VetDiagnosisAI v1.0 | Desenvolvido para profissionais veterin√°rios e pesquisadores</p>
    <p>‚ö†Ô∏è Ferramenta educacional - N√£o substitui avalia√ß√£o cl√≠nica profissional</p>
</div>
""", unsafe_allow_html=True)

